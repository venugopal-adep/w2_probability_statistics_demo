{% extends "base.html" %}

{% block title %}Sampling Distributions - Probability Distributions{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h1 class="display-5 mb-3">
                        <i class="fas fa-random text-primary me-2"></i>
                        Sampling Distributions Explorer
                    </h1>
                    <p class="lead">Explore how sample means behave and understand the Central Limit Theorem</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Controls Panel -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-sliders-h text-primary me-2"></i>Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="samplingForm">
                        <!-- Population Distribution -->
                        <div class="mb-3">
                            <label for="distribution" class="form-label">Population Distribution:</label>
                            <select class="form-select" id="distribution" name="distribution">
                                <option value="normal">Normal Distribution</option>
                                <option value="uniform">Uniform Distribution</option>
                                <option value="exponential">Exponential (Skewed)</option>
                                <option value="gamma">Gamma (Moderately Skewed)</option>
                                <option value="bimodal">Bimodal (Two Peaks)</option>
                            </select>
                        </div>

                        <!-- Population Parameters -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="mean" class="form-label">Population Mean (μ):</label>
                                <input type="number" class="form-control" id="mean" name="mean" value="50" min="10" max="90" step="5">
                            </div>
                            <div class="col-6">
                                <label for="std" class="form-label">Population Std (σ):</label>
                                <input type="number" class="form-control" id="std" name="std" value="10" min="2" max="20" step="1">
                            </div>
                        </div>

                        <!-- Sampling Parameters -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="sample_size" class="form-label">Sample Size (n):</label>
                                <input type="number" class="form-control" id="sample_size" name="sample_size" value="30" min="5" max="100" step="5">
                            </div>
                            <div class="col-6">
                                <label for="num_samples" class="form-label">Number of Samples:</label>
                                <input type="number" class="form-control" id="num_samples" name="num_samples" value="1000" min="100" max="5000" step="100">
                            </div>
                        </div>

                        <!-- Display Options -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_population" name="show_population" checked>
                                <label class="form-check-label" for="show_population">Show Population Distribution</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_sampling" name="show_sampling" checked>
                                <label class="form-check-label" for="show_sampling">Show Sampling Distribution</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_normal" name="show_normal">
                                <label class="form-check-label" for="show_normal">Show Normal Overlay</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_grid" name="show_grid" checked>
                                <label class="form-check-label" for="show_grid">Show Grid</label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i>Generate Plot
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Examples -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-rocket text-success me-2"></i>Quick Examples</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadExample('normal')">
                            <i class="fas fa-bell me-1"></i>Normal Population
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadExample('skewed')">
                            <i class="fas fa-chart-line me-1"></i>Skewed Population
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="loadExample('small_n')">
                            <i class="fas fa-compress me-1"></i>Small Sample Size
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="loadExample('large_n')">
                            <i class="fas fa-expand me-1"></i>Large Sample Size
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Display -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar text-info me-2"></i>Current Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Population Mean</small>
                                <div class="fw-bold" id="statMean">50.0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Population Std</small>
                                <div class="fw-bold" id="statStd">10.0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Sample Size</small>
                                <div class="fw-bold" id="statSampleSize">30</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Standard Error</small>
                                <div class="fw-bold" id="statSE">1.83</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            <strong>Standard Error Formula:</strong><br>
                            SE = σ / √n = <span id="seFormula">10 / √30 = 1.83</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plot Display -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area text-primary me-2"></i>Visualization</h5>
                </div>
                <div class="card-body">
                    <div id="plotContainer" style="min-height: 400px; position: relative;">
                        <!-- Loading State -->
                        <div id="loadingState" class="text-center" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>Generating plot...</div>
                        </div>

                        <!-- Plot Image -->
                        <img id="plotImage" src="" alt="Sampling Distribution Plot" class="img-fluid" style="display: none; max-width: 100%; height: auto;">

                        <!-- Placeholder -->
                        <div id="plotPlaceholder" class="text-center text-muted" style="padding: 100px 20px; border: 2px dashed #dee2e6; border-radius: 8px;">
                            <i class="fas fa-chart-area fa-4x mb-3"></i>
                            <h5>Ready to Generate Plot</h5>
                            <p>Adjust the parameters on the left and click "Generate Plot" to see the visualization.</p>
                        </div>

                        <!-- Error State -->
                        <div id="errorState" class="text-center text-danger" style="display: none; padding: 50px 20px;">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <h5>Error Generating Plot</h5>
                            <p id="errorMessage">Something went wrong. Please try again.</p>
                            <button class="btn btn-outline-primary" onclick="generatePlot()">
                                <i class="fas fa-redo me-1"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Educational Content -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-graduation-cap text-success me-2"></i>Central Limit Theorem</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Key Points:</h6>
                            <ul class="small">
                                <li>Sample means approach normal distribution</li>
                                <li>Works for <strong>any</strong> population shape</li>
                                <li>Larger sample size = more normal shape</li>
                                <li>Standard error decreases with larger n</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">What to Observe:</h6>
                            <ul class="small">
                                <li>Population can be any shape</li>
                                <li>Sampling distribution becomes bell-shaped</li>
                                <li>Mean stays the same (unbiased)</li>
                                <li>Spread gets narrower with larger n</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('samplingForm');
    const loadingState = document.getElementById('loadingState');
    const plotImage = document.getElementById('plotImage');
    const plotPlaceholder = document.getElementById('plotPlaceholder');
    const errorState = document.getElementById('errorState');
    
    // Update statistics display
    function updateStats() {
        const mean = parseFloat(document.getElementById('mean').value);
        const std = parseFloat(document.getElementById('std').value);
        const n = parseInt(document.getElementById('sample_size').value);
        
        const se = std / Math.sqrt(n);
        
        document.getElementById('statMean').textContent = mean.toFixed(1);
        document.getElementById('statStd').textContent = std.toFixed(1);
        document.getElementById('statSampleSize').textContent = n;
        document.getElementById('statSE').textContent = se.toFixed(2);
        document.getElementById('seFormula').textContent = `${std} / √${n} = ${se.toFixed(2)}`;
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        generatePlot();
    });

    // Update stats when inputs change
    ['mean', 'std', 'sample_size'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateStats);
    });

    // Generate plot function
    window.generatePlot = function() {
        // Show loading state
        plotPlaceholder.style.display = 'none';
        plotImage.style.display = 'none';
        errorState.style.display = 'none';
        loadingState.style.display = 'block';

        // Get form data
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // Convert form data to URL parameters
        for (let [key, value] of formData.entries()) {
            if (value === 'on') {
                params.append(key, 'true');
            } else {
                params.append(key, value);
            }
        }

        // Add unchecked checkboxes as false
        const checkboxes = ['show_population', 'show_sampling', 'show_normal', 'show_grid'];
        checkboxes.forEach(name => {
            if (!formData.has(name)) {
                params.append(name, 'false');
            }
        });

        // Make request to backend
        fetch(`/generate_sampling_plot?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.plot) {
                    // Show plot
                    loadingState.style.display = 'none';
                    plotImage.src = 'data:image/png;base64,' + data.plot;
                    plotImage.style.display = 'block';
                } else {
                    throw new Error('No plot data received');
                }
            })
            .catch(error => {
                // Show error state
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
                console.error('Error:', error);
            });
    };

    // Load example configurations
    window.loadExample = function(type) {
        switch(type) {
            case 'normal':
                document.getElementById('distribution').value = 'normal';
                document.getElementById('mean').value = 50;
                document.getElementById('std').value = 10;
                document.getElementById('sample_size').value = 30;
                break;
            case 'skewed':
                document.getElementById('distribution').value = 'exponential';
                document.getElementById('mean').value = 30;
                document.getElementById('std').value = 15;
                document.getElementById('sample_size').value = 30;
                break;
            case 'small_n':
                document.getElementById('distribution').value = 'uniform';
                document.getElementById('mean').value = 50;
                document.getElementById('std').value = 10;
                document.getElementById('sample_size').value = 5;
                break;
            case 'large_n':
                document.getElementById('distribution').value = 'gamma';
                document.getElementById('mean').value = 40;
                document.getElementById('std').value = 12;
                document.getElementById('sample_size').value = 100;
                break;
        }
        updateStats();
    };

    // Reset form
    window.resetForm = function() {
        document.getElementById('distribution').value = 'normal';
        document.getElementById('mean').value = 50;
        document.getElementById('std').value = 10;
        document.getElementById('sample_size').value = 30;
        document.getElementById('num_samples').value = 1000;
        
        document.getElementById('show_population').checked = true;
        document.getElementById('show_sampling').checked = true;
        document.getElementById('show_normal').checked = false;
        document.getElementById('show_grid').checked = true;
        
        updateStats();
        
        // Reset display
        plotImage.style.display = 'none';
        errorState.style.display = 'none';
        loadingState.style.display = 'none';
        plotPlaceholder.style.display = 'block';
    };

    // Initialize
    updateStats();
});
</script>
{% endblock %}