{% extends "base.html" %}

{% block title %}Sampling Distributions & Central Limit Theorem{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h1 class="display-5 mb-3">
                        <i class="fas fa-random text-primary me-2"></i>
                        Sampling Distributions & Central Limit Theorem
                    </h1>
                    <p class="lead">Explore how sample means behave and understand the Central Limit Theorem</p>
                    
                    <div class="alert alert-primary mt-3">
                        <h6 class="mb-2">
                            <i class="fas fa-quote-left me-2"></i>
                            <strong>Central Limit Theorem:</strong> The sampling distribution of sample means approaches normal distribution as sample size increases, regardless of population shape.
                        </h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Controls Panel -->
        <div class="col-lg-4">
            <!-- Mode Selection -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6><i class="fas fa-cogs text-primary me-2"></i>Visualization Mode</h6>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="mode" id="basicMode" value="basic" checked>
                        <label class="btn btn-outline-primary" for="basicMode">
                            <i class="fas fa-chart-bar me-1"></i>Basic
                        </label>
                        
                        <input type="radio" class="btn-check" name="mode" id="cltMode" value="clt">
                        <label class="btn btn-outline-success" for="cltMode">
                            <i class="fas fa-magic me-1"></i>CLT Demo
                        </label>
                        
                        <input type="radio" class="btn-check" name="mode" id="comparisonMode" value="comparison">
                        <label class="btn btn-outline-warning" for="comparisonMode">
                            <i class="fas fa-exchange-alt me-1"></i>Compare
                        </label>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-sliders-h text-primary me-2"></i>Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="samplingForm">
                        <!-- Population Distribution -->
                        <div class="mb-3">
                            <label for="distribution" class="form-label">Population Distribution:</label>
                            <select class="form-select" id="distribution" name="distribution">
                                <option value="normal">Normal Distribution</option>
                                <option value="uniform">Uniform Distribution</option>
                                <option value="exponential">Exponential (Skewed)</option>
                                <option value="gamma">Gamma (Moderately Skewed)</option>
                                <option value="bimodal">Bimodal (Two Peaks)</option>
                            </select>
                        </div>

                        <!-- Population Parameters -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="mean" class="form-label">Population Mean (μ):</label>
                                <input type="number" class="form-control" id="mean" name="mean" value="50" min="10" max="90" step="5">
                            </div>
                            <div class="col-6">
                                <label for="std" class="form-label">Population Std (σ):</label>
                                <input type="number" class="form-control" id="std" name="std" value="10" min="2" max="20" step="1">
                            </div>
                        </div>

                        <!-- Basic Mode Sampling Parameters -->
                        <div id="basicParams">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label for="sample_size" class="form-label">Sample Size (n):</label>
                                    <input type="number" class="form-control" id="sample_size" name="sample_size" value="30" min="5" max="100" step="5">
                                </div>
                                <div class="col-6">
                                    <label for="num_samples" class="form-label">Number of Samples:</label>
                                    <input type="number" class="form-control" id="num_samples" name="num_samples" value="1000" min="100" max="5000" step="100">
                                </div>
                            </div>
                        </div>

                        <!-- CLT Mode Parameters -->
                        <div id="cltParams" style="display: none;">
                            <div class="mb-3">
                                <label for="clt_sizes" class="form-label">Sample Sizes to Compare:</label>
                                <select class="form-select" id="clt_sizes" name="clt_sizes" multiple>
                                    <option value="5" selected>n = 5 (Small)</option>
                                    <option value="15" selected>n = 15 (Medium)</option>
                                    <option value="30" selected>n = 30 (CLT Threshold)</option>
                                    <option value="50">n = 50 (Large)</option>
                                    <option value="100">n = 100 (Very Large)</option>
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                            <div class="mb-3">
                                <label for="clt_num_samples" class="form-label">Number of Samples:</label>
                                <input type="number" class="form-control" id="clt_num_samples" name="clt_num_samples" value="1000" min="500" max="3000" step="100">
                            </div>
                        </div>

                        <!-- Comparison Mode Parameters -->
                        <div id="comparisonParams" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <label for="n1" class="form-label">Size 1 (n₁):</label>
                                    <input type="number" class="form-control" id="n1" name="n1" value="10" min="5" max="100" step="5">
                                </div>
                                <div class="col-4">
                                    <label for="n2" class="form-label">Size 2 (n₂):</label>
                                    <input type="number" class="form-control" id="n2" name="n2" value="30" min="5" max="100" step="5">
                                </div>
                                <div class="col-4">
                                    <label for="n3" class="form-label">Size 3 (n₃):</label>
                                    <input type="number" class="form-control" id="n3" name="n3" value="50" min="5" max="100" step="5">
                                </div>
                            </div>
                        </div>

                        <!-- Display Options -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_population" name="show_population" checked>
                                <label class="form-check-label" for="show_population">Show Population Distribution</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_sampling" name="show_sampling" checked>
                                <label class="form-check-label" for="show_sampling">Show Sampling Distribution</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_normal" name="show_normal">
                                <label class="form-check-label" for="show_normal">Show Normal Overlay</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_grid" name="show_grid" checked>
                                <label class="form-check-label" for="show_grid">Show Grid</label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i>Generate Visualization
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Examples -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-rocket text-success me-2"></i>Quick Examples</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadExample('normal')">
                            <i class="fas fa-bell me-1"></i>Normal Population
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadExample('skewed')">
                            <i class="fas fa-chart-line me-1"></i>Skewed Population
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="loadExample('clt_demo')">
                            <i class="fas fa-magic me-1"></i>CLT Demonstration
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="loadExample('size_comparison')">
                            <i class="fas fa-exchange-alt me-1"></i>Size Comparison
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Display -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar text-info me-2"></i>Current Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Population Mean</small>
                                <div class="fw-bold" id="statMean">50.0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Population Std</small>
                                <div class="fw-bold" id="statStd">10.0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Sample Size</small>
                                <div class="fw-bold" id="statSampleSize">30</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2 mb-2">
                                <small class="text-muted">Standard Error</small>
                                <div class="fw-bold" id="statSE">1.83</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            <strong>Standard Error Formula:</strong><br>
                            SE = σ / √n = <span id="seFormula">10 / √30 = 1.83</span>
                        </small>
                    </div>
                    
                    <!-- CLT Status -->
                    <div class="mt-2 text-center">
                        <span id="cltStatus" class="badge bg-success">CLT applies (n≥30)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plot Display -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area text-primary me-2"></i>Visualization</h5>
                </div>
                <div class="card-body">
                    <div id="plotContainer" style="min-height: 400px; position: relative;">
                        <!-- Loading State -->
                        <div id="loadingState" class="text-center" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>Generating visualization...</div>
                        </div>

                        <!-- Plot Image -->
                        <img id="plotImage" src="" alt="Sampling Distribution Plot" class="img-fluid" style="display: none; max-width: 100%; height: auto;">

                        <!-- Placeholder -->
                        <div id="plotPlaceholder" class="text-center text-muted" style="padding: 100px 20px; border: 2px dashed #dee2e6; border-radius: 8px;">
                            <i class="fas fa-chart-area fa-4x mb-3"></i>
                            <h5>Ready to Generate Visualization</h5>
                            <p>Select a mode and adjust parameters, then click "Generate Visualization".</p>
                        </div>

                        <!-- Error State -->
                        <div id="errorState" class="text-center text-danger" style="display: none; padding: 50px 20px;">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <h5>Error Generating Plot</h5>
                            <p id="errorMessage">Something went wrong. Please try again.</p>
                            <button class="btn btn-outline-primary" onclick="generatePlot()">
                                <i class="fas fa-redo me-1"></i>Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Educational Content Tabs -->
            <div class="card mt-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="educationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="clt-tab" data-bs-toggle="tab" data-bs-target="#clt-content" type="button" role="tab">
                                <i class="fas fa-magic me-1"></i>Central Limit Theorem
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties-content" type="button" role="tab">
                                <i class="fas fa-list-check me-1"></i>Key Properties
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="formulas-tab" data-bs-toggle="tab" data-bs-target="#formulas-content" type="button" role="tab">
                                <i class="fas fa-calculator me-1"></i>Formulas
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="educationTabContent">
                        <!-- CLT Content -->
                        <div class="tab-pane fade show active" id="clt-content" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">CLT Assumptions:</h6>
                                    <ul class="small">
                                        <li><strong>Random Sampling:</strong> Data must be randomly sampled</li>
                                        <li><strong>Independence:</strong> Sample values must be independent</li>
                                        <li><strong>Same Distribution:</strong> Samples from same distribution</li>
                                        <li><strong>Large Sample:</strong> Sample size ≥ 30 (magic number!)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success">What to Observe:</h6>
                                    <ul class="small">
                                        <li>Population can be any shape</li>
                                        <li>Sampling distribution becomes bell-shaped</li>
                                        <li>Mean stays the same (unbiased)</li>
                                        <li>Spread gets narrower with larger n</li>
                                        <li>Works regardless of population shape!</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Properties Content -->
                        <div class="tab-pane fade" id="properties-content" role="tabpanel">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-bell fa-2x text-primary mb-2"></i>
                                        <h6>Shape</h6>
                                        <small>Always becomes normal</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-crosshairs fa-2x text-success mb-2"></i>
                                        <h6>Mean</h6>
                                        <small>μ_x̄ = μ</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-arrows-alt-h fa-2x text-warning mb-2"></i>
                                        <h6>Std Error</h6>
                                        <small>σ_x̄ = σ/√n</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <i class="fas fa-expand fa-2x text-info mb-2"></i>
                                        <h6>As n↑</h6>
                                        <small>Distribution narrows</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulas Content -->
                        <div class="tab-pane fade" id="formulas-content" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-6">
                                    <h6>Sampling Distribution of Sample Means</h6>
                                    <div class="bg-light p-3 rounded border text-center mb-3" style="font-size: 1.2em;">
                                        <em>X̄</em> ~ N(<em>μ</em>, <em>σ</em>/√<em>n</em>)
                                    </div>
                                    <small><strong>Interpretation:</strong> Sample means follow normal distribution with mean μ and standard error σ/√n</small>
                                </div>
                                <div class="col-lg-6">
                                    <h6>Standardization (Z-Score)</h6>
                                    <div class="bg-light p-3 rounded border text-center mb-3" style="font-size: 1.2em;">
                                        <em>Z</em> = (<em>X̄</em> - <em>μ</em>) / (<em>σ</em>/√<em>n</em>)
                                    </div>
                                    <small><strong>Use:</strong> Convert sample means to standard normal for probability calculations</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('samplingForm');
    const loadingState = document.getElementById('loadingState');
    const plotImage = document.getElementById('plotImage');
    const plotPlaceholder = document.getElementById('plotPlaceholder');
    const errorState = document.getElementById('errorState');
    
    // Mode switching
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const basicParams = document.getElementById('basicParams');
    const cltParams = document.getElementById('cltParams');
    const comparisonParams = document.getElementById('comparisonParams');
    
    modeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Hide all parameter sections
            basicParams.style.display = 'none';
            cltParams.style.display = 'none';
            comparisonParams.style.display = 'none';
            
            // Show relevant parameter section
            switch(this.value) {
                case 'basic':
                    basicParams.style.display = 'block';
                    break;
                case 'clt':
                    cltParams.style.display = 'block';
                    break;
                case 'comparison':
                    comparisonParams.style.display = 'block';
                    break;
            }
            updateStats();
        });
    });

    // Update statistics display
    function updateStats() {
        const mean = parseFloat(document.getElementById('mean').value);
        const std = parseFloat(document.getElementById('std').value);
        const mode = document.querySelector('input[name="mode"]:checked').value;
        
        let n = 30; // default
        if (mode === 'basic') {
            n = parseInt(document.getElementById('sample_size').value);
        } else if (mode === 'comparison') {
            n = parseInt(document.getElementById('n2').value); // Use middle value for display
        }
        
        const se = std / Math.sqrt(n);
        
        document.getElementById('statMean').textContent = mean.toFixed(1);
        document.getElementById('statStd').textContent = std.toFixed(1);
        document.getElementById('statSampleSize').textContent = n;
        document.getElementById('statSE').textContent = se.toFixed(2);
        document.getElementById('seFormula').textContent = `${std} / √${n} = ${se.toFixed(2)}`;
        
        // Update CLT status
        const cltStatus = document.getElementById('cltStatus');
        if (n >= 30) {
            cltStatus.textContent = 'CLT applies (n≥30)';
            cltStatus.className = 'badge bg-success';
        } else {
            cltStatus.textContent = `CLT may not apply (n=${n})`;
            cltStatus.className = 'badge bg-warning';
        }
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        generatePlot();
    });

    // Update stats when inputs change
    ['mean', 'std', 'sample_size', 'n1', 'n2', 'n3'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateStats);
        }
    });

    // Generate plot function
    window.generatePlot = function() {
        // Show loading state
        plotPlaceholder.style.display = 'none';
        plotImage.style.display = 'none';
        errorState.style.display = 'none';
        loadingState.style.display = 'block';

        // Get current mode
        const mode = document.querySelector('input[name="mode"]:checked').value;
        
        // Build URL based on mode
        let url = '/generate_sampling_plot?';
        const params = new URLSearchParams();
        
        // Common parameters
        params.append('distribution', document.getElementById('distribution').value);
        params.append('mean', document.getElementById('mean').value);
        params.append('std', document.getElementById('std').value);
        params.append('show_population', document.getElementById('show_population').checked);
        params.append('show_sampling', document.getElementById('show_sampling').checked);
        params.append('show_normal', document.getElementById('show_normal').checked);
        params.append('show_grid', document.getElementById('show_grid').checked);
        
        // Mode-specific parameters
        if (mode === 'basic') {
            params.append('sample_size', document.getElementById('sample_size').value);
            params.append('num_samples', document.getElementById('num_samples').value);
        } else if (mode === 'clt') {
            const selectedSizes = Array.from(document.getElementById('clt_sizes').selectedOptions).map(o => o.value);
            params.append('clt_mode', 'true');
            params.append('clt_sizes', selectedSizes.join(','));
            params.append('num_samples', document.getElementById('clt_num_samples').value);
        } else if (mode === 'comparison') {
            params.append('comparison', 'true');
            params.append('sample_size', document.getElementById('n1').value);
            params.append('n2', document.getElementById('n2').value);
            params.append('n3', document.getElementById('n3').value);
            params.append('num_samples', '1000');
        }

        // Make request to backend
        fetch(`${url}${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.plot) {
                    // Show plot
                    loadingState.style.display = 'none';
                    plotImage.src = 'data:image/png;base64,' + data.plot;
                    plotImage.style.display = 'block';
                } else {
                    throw new Error('No plot data received');
                }
            })
            .catch(error => {
                // Show error state
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
                console.error('Error:', error);
            });
    };

    // Load example configurations
    window.loadExample = function(type) {
        switch(type) {
            case 'normal':
                document.getElementById('basicMode').checked = true;
                document.getElementById('distribution').value = 'normal';
                document.getElementById('mean').value = 50;
                document.getElementById('std').value = 10;
                document.getElementById('sample_size').value = 30;
                break;
            case 'skewed':
                document.getElementById('basicMode').checked = true;
                document.getElementById('distribution').value = 'exponential';
                document.getElementById('mean').value = 30;
                document.getElementById('std').value = 15;
                document.getElementById('sample_size').value = 30;
                break;
            case 'clt_demo':
                document.getElementById('cltMode').checked = true;
                document.getElementById('distribution').value = 'uniform';
                document.getElementById('mean').value = 50;
                document.getElementById('std').value = 12;
                // Select specific sizes for CLT demo
                const cltSizes = document.getElementById('clt_sizes');
                Array.from(cltSizes.options).forEach(option => {
                    option.selected = ['5', '15', '30'].includes(option.value);
                });
                break;
            case 'size_comparison':
                document.getElementById('comparisonMode').checked = true;
                document.getElementById('distribution').value = 'gamma';
                document.getElementById('mean').value = 40;
                document.getElementById('std').value = 12;
                document.getElementById('n1').value = 10;
                document.getElementById('n2').value = 30;
                document.getElementById('n3').value = 50;
                break;
        }
        
        // Trigger mode change
        document.querySelector('input[name="mode"]:checked').dispatchEvent(new Event('change'));
        updateStats();
    };

    // Reset form
    window.resetForm = function() {
        document.getElementById('basicMode').checked = true;
        document.getElementById('distribution').value = 'normal';
        document.getElementById('mean').value = 50;
        document.getElementById('std').value = 10;
        document.getElementById('sample_size').value = 30;
        document.getElementById('num_samples').value = 1000;
        
        document.getElementById('show_population').checked = true;
        document.getElementById('show_sampling').checked = true;
        document.getElementById('show_normal').checked = false;
        document.getElementById('show_grid').checked = true;
        
        // Reset mode
        document.getElementById('basicMode').dispatchEvent(new Event('change'));
        updateStats();
        
        // Reset display
        plotImage.style.display = 'none';
        errorState.style.display = 'none';
        loadingState.style.display = 'none';
        plotPlaceholder.style.display = 'block';
    };

    // Initialize
    updateStats();
});
</script>
{% endblock %}